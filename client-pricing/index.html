<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å®¢æˆ·ä¸“å±ä»·å¡ç³»ç»Ÿï¼ˆå«æ—¶åˆ†ç§’ & è‡ªåŠ¨æ‹†åˆ† & çŠ¶æ€ç»Ÿä¸€ï¼‰</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/antd/4.24.11/antd.min.css" />
  <style>
    body {
      font-family: 'Segoe UI', 'PingFang SC', sans-serif;
      background: #f5f7fa;
      margin: 0;
      padding: 20px;
    }
    .app {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      padding: 24px;
    }
    .title {
      font-size: 1.3rem;
      color: #1890ff;
      margin-bottom: 16px;
    }
    .btn-primary {
      background: #1890ff;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 16px;
      font-weight: 500;
      cursor: pointer;
    }
    .btn-primary:disabled {
      background: #bfbfbf;
      cursor: not-allowed;
    }
    .config-group {
      margin-bottom: 16px;
    }
    .config-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: #595959;
    }
    .tier-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
      margin-bottom: 8px;
      align-items: center;
    }
    .preview-card {
      border: 1px dashed #1890ff;
      padding: 16px;
      background: #e6f7ff;
    }
    select, input[type="number"], input[type="text"] {
      width: 100%;
      padding: 8px;
      border: 1px solid #d9d9d9;
      border-radius: 6px;
    }
    table.ant-table {
      border-collapse: collapse;
      width: 100%;
    }
    table.ant-table th,
    table.ant-table td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #f0f0f0;
    }
    table.ant-table th {
      background-color: #fafafa;
      font-weight: 600;
    }
    .debug-info {
      font-size: 0.8rem;
      color: #8c8c8c;
      margin-top: 8px;
      padding: 6px;
      background: #f9f9f9;
      border-radius: 4px;
    }
    .status-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 500;
      margin-left: 8px;
    }
    .quote-card {
      margin-bottom: 16px;
      padding: 16px;
      border-radius: 8px;
      transition: all 0.2s;
      border: 1px solid #e8e8e8;
    }
    .quote-card.active {
      border: 2px solid #52c41a;
      background-color: #f6ffed;
    }
    /* .quote-card.split {  æ³¨é‡Šæ‰æˆ–åˆ é™¤æ‹†åˆ†çŠ¶æ€çš„æ ·å¼ */
    /*   background-color: #f9f0ff; */
    /*   border-left: 4px solid #722ed1; */
    /* } */
    .quote-card.expired {
      opacity: 0.6;
      background-color: #f5f5f5;
    }
    .quote-card.pending {
      background-color: #fffbe6;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- è„šæœ¬åŠ è½½ -->
  <script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/antd/4.24.11/antd.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;
    const { Modal, message, InputNumber, DatePicker, Input } = antd;

    // ====== é™æ€é…ç½® ======
    const warehouseGroups = [
      { id: 1, name: "åä¸œä»“ç¾¤", code: "EAST" },
      { id: 2, name: "åå—ä»“ç¾¤", code: "SOUTH" }
    ];

    const costTypes = [
      { id: 1, name: "ä»“å‚¨è´¹", warehouseGroupId: 1, unit: "mÂ³" },
      { id: 2, name: "è£…å¸è´¹", warehouseGroupId: 1, unit: "æ¬¡" },
      { id: 3, name: "ä»“å‚¨è´¹", warehouseGroupId: 2, unit: "mÂ³" }
    ];

    const customers = [
      { 
        id: 1, 
        name: "å®¢æˆ·Aï¼ˆç”µå•†å¤§ä»“ï¼‰", 
        type: "VIP",
        defaultWarehouseGroupId: 1,
        defaultCostTypeId: 1
      },
      { 
        id: 2, 
        name: "å®¢æˆ·Bï¼ˆç”Ÿé²œå†·é“¾ï¼‰", 
        type: "Standard",
        defaultWarehouseGroupId: 2,
        defaultCostTypeId: 3
      }
    ];

    // æ ¼å¼åŒ–æ—¥æœŸä¸º YYYY-MM-DD HH:mm:ss
    function formatDateWithTime(date) {
      const pad = n => String(n).padStart(2, '0');
      return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())} ${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}`;
    }

    // è·å–ä¸€å¹´æœ‰æ•ˆæœŸï¼ˆç²¾ç¡®åˆ°ç§’ï¼‰
    function getOneYearLaterEnd(startStr) {
      const start = new Date(startStr);
      start.setHours(0, 0, 0, 0); // ä»å½“å¤© 00:00:00 å¼€å§‹

      const end = new Date(start);
      end.setFullYear(end.getFullYear() + 1);
      end.setSeconds(end.getSeconds() - 1); // ç»“æŸäºå‰ä¸€ç§’

      return {
        effectiveDate: formatDateWithTime(start),
        expiryDate: formatDateWithTime(end)
      };
    }

    // ====== ä¸»ç»„ä»¶ ======
    function App() {
      const today = new Date();
      const [warehouseGroupId, setWarehouseGroupId] = useState(1);
      const [costTypeId, setCostTypeId] = useState(1);
      const [startDate, setStartDate] = useState(formatDateWithTime(today).split(' ')[0]); // åªå–æ—¥æœŸéƒ¨åˆ†ç”¨äº DatePicker
      const [costs, setCosts] = useState([]);
      const [publicQuotes, setPublicQuotes] = useState([]);
      const [customerQuotes, setCustomerQuotes] = useState([]);
      const [globalDiscount, setGlobalDiscount] = useState(100);
      const [selectedCustomerId, setSelectedCustomerId] = useState(1);
      const [selectedPublicQuoteId, setSelectedPublicQuoteId] = useState(null);
      const [profitMargin, setProfitMargin] = useState(0.2);
      const [expandedQuoteId, setExpandedQuoteId] = useState(null);
      const [quoteName, setQuoteName] = useState('');

      const [customerContext, setCustomerContext] = useState({
        warehouseGroupId: 1,
        costTypeId: 1
      });

      const [showCostModal, setShowCostModal] = useState(false);
      const [tempTiers, setTempTiers] = useState([
        { start: 0, end: 100, unitCost: 8 },
        { start: 101, end: 500, unitCost: 7 },
        { start: 501, end: Infinity, unitCost: 6 }
      ]);

      // å®¢æˆ·åˆ‡æ¢åŒæ­¥ä¸Šä¸‹æ–‡
      useEffect(() => {
        const customer = customers.find(c => c.id === selectedCustomerId);
        if (customer) {
          setCustomerContext({
            warehouseGroupId: customer.defaultWarehouseGroupId,
            costTypeId: customer.defaultCostTypeId
          });
          setWarehouseGroupId(customer.defaultWarehouseGroupId);
          setCostTypeId(customer.defaultCostTypeId);
          setSelectedPublicQuoteId(null);
        }
      }, [selectedCustomerId]);

      const filteredCostTypes = costTypes.filter(ct => ct.warehouseGroupId === warehouseGroupId);
      const { effectiveDate, expiryDate } = getOneYearLaterEnd(startDate);

      const currentCost = costs.find(c =>
        c.warehouseGroupId === customerContext.warehouseGroupId &&
        c.costTypeId === customerContext.costTypeId &&
        c.startDate === startDate
      );

      const selectedPublicQuote = publicQuotes.find(q => q.id === selectedPublicQuoteId);

      const availablePublicQuotes = useMemo(() => {
        return publicQuotes.filter(q =>
          q.warehouseGroupId === customerContext.warehouseGroupId &&
          q.costTypeId === customerContext.costTypeId
        );
      }, [publicQuotes, customerContext]);

      const openCostModal = () => {
        if (currentCost) {
          setTempTiers([...currentCost.tiers]);
        } else {
          setTempTiers([
            { start: 0, end: 100, unitCost: 8 },
            { start: 101, end: 500, unitCost: 7 },
            { start: 501, end: Infinity, unitCost: 6 }
          ]);
        }
        setShowCostModal(true);
      };

      const saveCost = () => {
        const newCost = {
          warehouseGroupId: customerContext.warehouseGroupId,
          costTypeId: customerContext.costTypeId,
          startDate,
          tiers: tempTiers
        };

        if (currentCost) {
          setCosts(costs.map(c => c.id === currentCost.id ? { ...newCost, id: c.id } : c));
        } else {
          setCosts([...costs, { ...newCost, id: Date.now() }]);
        }

        setShowCostModal(false);
        message.success('âœ… æˆæœ¬å·²ä¿å­˜');
      };

      const generatePublicQuote = () => {
        if (!currentCost) {
          message.error('è¯·å…ˆè®¾ç½®æˆæœ¬');
          return;
        }

        const { warehouseGroupId: ctxWg, costTypeId: ctxCt } = customerContext;
        if (
          currentCost.warehouseGroupId !== ctxWg ||
          currentCost.costTypeId !== ctxCt
        ) {
          message.error('æˆæœ¬ä¸å®¢æˆ·ä¸Šä¸‹æ–‡ä¸åŒ¹é…');
          return;
        }

        const defaultName = quoteName.trim() || `å…¬æŠ¥ä»·-${startDate}`;
        const quoteTiers = currentCost.tiers.map(tier => ({
          ...tier,
          publicPrice: tier.unitCost * (1 + profitMargin)
        }));

        const newQuote = {
          id: Date.now(),
          name: defaultName,
          warehouseGroupId: ctxWg,
          costTypeId: ctxCt,
          startDate,
          effectiveDate,
          expiryDate,
          profitMargin,
          tiers: quoteTiers
        };

        setPublicQuotes(prev => [...prev, newQuote]);
        setQuoteName('');
        setSelectedPublicQuoteId(newQuote.id);
        message.success(`âœ… å…¬æŠ¥ä»·ã€Œ${defaultName}ã€å·²ç”Ÿæˆ`);
      };

      // âœ… æ ¸å¿ƒï¼šä¿å­˜å®¢æˆ·ä»·å¡ + è‡ªåŠ¨æ—¶é—´æ‹†åˆ†ï¼ˆå«æ—¶åˆ†ç§’ï¼‰ï¼Œéšè—æ‹†åˆ†çŠ¶æ€
      const handleSaveCustomerQuote = () => {
        if (!selectedPublicQuote) {
          message.error('è¯·é€‰æ‹©ä¸€ä¸ªå…¬æŠ¥ä»·');
          return;
        }

        const inputs = document.querySelectorAll('#customerTiersContainer input[name="price"]');
        const newQuote = {
          id: Date.now(),
          customerId: selectedCustomerId,
          warehouseGroupId: selectedPublicQuote.warehouseGroupId,
          costTypeId: selectedPublicQuote.costTypeId,
          effectiveDate: selectedPublicQuote.effectiveDate,
          expiryDate: selectedPublicQuote.expiryDate,
          status: 'active', // æ–°ä¿å­˜çš„å¡ç‰‡çŠ¶æ€ä¸º active
          tiers: selectedPublicQuote.tiers.map((tier, i) => ({
            ...tier,
            price: parseFloat(inputs[i]?.value) || tier.publicPrice
          }))
        };

        const newStart = new Date(newQuote.effectiveDate);
        const newEnd = new Date(newQuote.expiryDate);

        // æ‰¾å‡ºåŒå®¢æˆ·+åŒé…ç½®çš„æ‰€æœ‰æ—§ä»·å¡
        const sameGroupQuotes = customerQuotes.filter(q =>
          q.customerId === newQuote.customerId &&
          q.warehouseGroupId === newQuote.warehouseGroupId &&
          q.costTypeId === newQuote.costTypeId
        );

        let hasOverlap = false;
        const updatedQuotes = [];
        let idCounter = 1; // ç”¨äºç”Ÿæˆå”¯ä¸€IDçš„å°è®¡æ•°å™¨

        // éå†æ—§ä»·å¡ï¼Œè¿›è¡Œåˆ‡å‰²
        for (const old of sameGroupQuotes) {
          const oldStart = new Date(old.effectiveDate);
          const oldEnd = new Date(old.expiryDate);

          // åˆ¤æ–­æ˜¯å¦é‡å ï¼š!(oldEnd < newStart || oldStart > newEnd)
          if (oldEnd < newStart || oldStart > newEnd) {
            // æ— é‡å  â†’ ä¿ç•™åŸæ ·
            updatedQuotes.push(old);
          } else {
            // æœ‰é‡å  â†’ æ ‡è®°å¹¶åˆ‡å‰²
            hasOverlap = true;

            // 1. å‰æ®µï¼š[oldStart, newStart - 1ç§’]
            if (oldStart < newStart) {
              const preEnd = new Date(newStart.getTime() - 1000); // å‡1ç§’
              updatedQuotes.push({
                ...old,
                id: Date.now() + idCounter++, // ç¡®ä¿å”¯ä¸€
                expiryDate: formatDateWithTime(preEnd),
                status: 'active' // åˆ‡ç‰‡ä¹Ÿè®¾ä¸º active
              });
            }

            // 2. åæ®µï¼š[newEnd + 1ç§’, oldEnd]
            if (oldEnd > newEnd) {
              const postStart = new Date(newEnd.getTime() + 1000); // åŠ 1ç§’
              updatedQuotes.push({
                ...old,
                id: Date.now() + idCounter++,
                effectiveDate: formatDateWithTime(postStart),
                status: 'active' // åˆ‡ç‰‡ä¹Ÿè®¾ä¸º active
              });
            }

            // æ—§å¡ä¸­é—´é‡å éƒ¨åˆ†è¢«ä¸¢å¼ƒï¼ˆç”±æ–°å¡è¦†ç›–ï¼‰
          }
        }

        // å°†æ–°å¡åŠ å…¥
        const finalQuotes = [...updatedQuotes, newQuote];

        setCustomerQuotes(finalQuotes);

        if (hasOverlap) {
          message.success('âœ… æ—¶é—´é‡å å·²è‡ªåŠ¨å¤„ç†ï¼Œä»·å¡å·²ä¿å­˜');
        } else {
          message.success('âœ… å®¢æˆ·ä»·å¡ä¿å­˜æˆåŠŸ');
        }
      };


      const handleExport = (quoteToExport = null) => {
        const quote = quoteToExport || (customerQuotes.length > 0 ? customerQuotes[0] : null);
        if (!quote) {
          message.warning('æ— å¯å¯¼å‡ºçš„ä»·å¡');
          return;
        }
        const csvContent = [
          ['é˜¶æ¢¯èŒƒå›´', 'ä¸“å±ä»·', 'æœ‰æ•ˆæœŸ'],
          ...quote.tiers.map(t => [`${t.start}-${t.end === Infinity ? 'âˆ' : t.end}mÂ³`, `Â¥${t.price.toFixed(2)}`, `${quote.effectiveDate} ~ ${quote.expiryDate}`])
        ].map(row => row.join(',')).join('\n');

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `å®¢æˆ·ä¸“å±ä»·å¡_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      };

      const renderCustomerTiers = () => {
        if (!selectedPublicQuote) return <div style={{ color: '#8c8c8c' }}>è¯·é€‰æ‹©ä¸€ä¸ªå…¬æŠ¥ä»·</div>;
        return selectedPublicQuote.tiers.map((tier, i) => {
          const discountedPrice = (tier.publicPrice * (globalDiscount / 100)).toFixed(2);
          return (
            <div key={i} className="tier-row">
              <span>{tier.start}-{tier.end === Infinity ? 'âˆ' : tier.end} mÂ³</span>
              <input
                type="number"
                name="price"
                defaultValue={discountedPrice}
                min="0.01"
                step="0.01"
                style={{ padding: '8px', border: '1px solid #d9d9d9', borderRadius: '4px', width: '100%' }}
              />
              <span style={{ color: '#8c8c8c' }}>{tier.note || ''}</span>
            </div>
          );
        });
      };

      const currentCustomer = customers.find(c => c.id === selectedCustomerId);
      const contextWg = warehouseGroups.find(w => w.id === customerContext.warehouseGroupId)?.name || 'æœªçŸ¥';
      const contextCt = costTypes.find(c => c.id === customerContext.costTypeId)?.name || 'æœªçŸ¥';

      const canGenerate = currentCost && 
        currentCost.warehouseGroupId === customerContext.warehouseGroupId &&
        currentCost.costTypeId === customerContext.costTypeId;

      // ========================
      // âœ… ä¼˜åŒ–é¢„è§ˆï¼šå«æ—¶åˆ†ç§’ + çŠ¶æ€ç»Ÿä¸€ï¼ˆéšè—æ‹†åˆ†ï¼‰+ ä¿®å¤é¢„è§ˆä¸æ˜¾ç¤ºé—®é¢˜
      // ========================
      const renderCustomerQuotesPreview = () => {
         // 1. ä¿®å¤ç‚¹ï¼šå§‹ç»ˆåŸºäºå½“å‰é€‰ä¸­çš„å®¢æˆ· ID æ¥ç­›é€‰ä»·å¡
        const currentCustomerQuotes = customerQuotes.filter(q => q.customerId === selectedCustomerId);

        if (currentCustomerQuotes.length === 0) {
          return <p style={{ textAlign: 'center', color: '#8c8c8c', marginTop: '24px' }}>æš‚æ— å®¢æˆ·ä»·å¡ï¼Œè¯·å…ˆä¿å­˜</p>;
        }

        // 2. å¯¹å½“å‰å®¢æˆ·çš„æ‰€æœ‰ä»·å¡æŒ‰å®¢æˆ·-ä»“åº“-æˆæœ¬ç±»å‹è¿›è¡Œåˆ†ç»„
        const groups = {};
        currentCustomerQuotes.forEach(quote => {
          const key = `${quote.customerId}-${quote.warehouseGroupId}-${quote.costTypeId}`;
          if (!groups[key]) groups[key] = [];
          groups[key].push(quote);
        });

        const now = new Date(); // è·å–å½“å‰æ—¶é—´ç”¨äºçŠ¶æ€åˆ¤æ–­

        return Object.values(groups).map((group, groupIndex) => {
          // æŒ‰ç”Ÿæ•ˆæ—¥æœŸæ’åº
          const sortedGroup = [...group].sort((a, b) => 
            new Date(a.effectiveDate) - new Date(b.effectiveDate)
          );

          let currentActiveQuote = null; // ç”¨äºæ ‡è®°å½“å‰ç”Ÿæ•ˆçš„ä»·å¡
          
          // ä¸ºæ¯ä¸ªä»·å¡è®¡ç®—å¹¶é™„åŠ æ˜¾ç¤ºçŠ¶æ€å’Œæ ·å¼ç±»
          const enhancedQuotes = sortedGroup.map(quote => {
            const effective = new Date(quote.effectiveDate);
            const expiry = new Date(quote.expiryDate);
            
            let displayStatus = '';
            let statusColor = '#bfbfbf';
            let cardClass = '';

            // ä¸å†åŒºåˆ† 'split' çŠ¶æ€ï¼Œç»Ÿä¸€æ ¹æ®æ—¶é—´åˆ¤æ–­
            if (now < effective) {
              displayStatus = 'å¾…ç”Ÿæ•ˆ';
              statusColor = '#faad14';
              cardClass = 'pending';
            } else if (now > expiry) {
              displayStatus = 'å·²è¿‡æœŸ';
              statusColor = '#ff4d4f';
              cardClass = 'expired';
            } else {
              displayStatus = 'ç”Ÿæ•ˆä¸­'; // åŒ…æ‹¬äº†æ–°å¡å’Œæ‹†åˆ†åçš„ç‰‡æ®µ
              statusColor = '#52c41a';
              cardClass = 'active';
              // å¦‚æœè¿˜æ²¡æœ‰æ‰¾åˆ°å½“å‰ç”Ÿæ•ˆçš„ä»·å¡ï¼Œåˆ™å½“å‰è¿™ä¸ªå°±æ˜¯
              if (!currentActiveQuote) currentActiveQuote = quote; 
            }

            return { ...quote, displayStatus, statusColor, cardClass };
          });

          // è·å–åˆ†ç»„ä¿¡æ¯ç”¨äºæ ‡é¢˜
          const first = enhancedQuotes[0];
          const customer = customers.find(c => c.id === first.customerId);
          const wg = warehouseGroups.find(g => g.id === first.warehouseGroupId);
          const ct = costTypes.find(t => t.id === first.costTypeId);

          return (
            <div key={groupIndex} style={{ marginBottom: '28px' }}>
              {/* åˆ†ç»„æ ‡é¢˜ */}
              <div style={{
                padding: '12px',
                background: '#f0f7ff',
                borderRadius: '8px',
                borderLeft: '4px solid #1890ff',
                marginBottom: '12px'
              }}>
                <strong>{customer?.name}</strong> Â· {wg?.name} - {ct?.name}
              </div>

              {/* æ¸²æŸ“è¯¥åˆ†ç»„ä¸‹çš„æ‰€æœ‰ä»·å¡ */}
              {enhancedQuotes.map((quote) => {
                const isExpanded = expandedQuoteId === quote.id;
                return (
                  <div key={quote.id} className={`quote-card ${quote.cardClass}`}>
                    {/* ä»·å¡å¤´éƒ¨ï¼šæ—¶é—´èŒƒå›´å’ŒçŠ¶æ€ */}
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '12px' }}>
                      <div>
                        <span>ç”Ÿæ•ˆæœŸï¼š{quote.effectiveDate} ~ {quote.expiryDate}</span>
                        {/* çŠ¶æ€å¾½ç«  */}
                        <span
                          className="status-badge"
                          style={{ backgroundColor: quote.statusColor + '20', color: quote.statusColor }}
                        >
                          {quote.displayStatus}
                        </span>
                        {/* å½“å‰ç”Ÿæ•ˆæ ‡è¯† */}
                        {currentActiveQuote?.id === quote.id && (
                          <span
                            className="status-badge"
                            style={{ backgroundColor: '#52c41a20', color: '#52c41a', marginLeft: '8px' }}
                          >
                            å½“å‰ç”Ÿæ•ˆ
                          </span>
                        )}
                      </div>
                      {/* å±•å¼€/æ”¶èµ·æŒ‰é’® */}
                      <button
                        onClick={() => setExpandedQuoteId(isExpanded ? null : quote.id)}
                        style={{
                          background: isExpanded ? '#ff7875' : '#1890ff',
                          color: 'white',
                          border: 'none',
                          borderRadius: '4px',
                          padding: '4px 12px',
                          fontSize: '0.85rem',
                          cursor: 'pointer'
                        }}
                      >
                        {isExpanded ? 'æ”¶èµ·è¯¦æƒ…' : 'æŸ¥çœ‹è¯¦æƒ…'}
                      </button>
                    </div>

                    {/* ä»·å¡è¯¦æƒ…ï¼ˆå±•å¼€æ—¶æ˜¾ç¤ºï¼‰ */}
                    {isExpanded && (
                      <div style={{ marginTop: '16px', paddingTop: '16px', borderTop: '1px dashed #d9d9d9' }}>
                        <table className="ant-table">
                          <thead>
                            <tr>
                              <th>é˜¶æ¢¯èŒƒå›´</th>
                              <th>ä¸“å±ä»·ï¼ˆÂ¥ï¼‰</th>
                            </tr>
                          </thead>
                          <tbody>
                            {quote.tiers.map((t, i) => (
                              <tr key={i}>
                                <td>{t.start}â€“{t.end === Infinity ? 'âˆ' : t.end} mÂ³</td>
                                <td>{t.price.toFixed(2)}</td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                        <div style={{ display: 'flex', justifyContent: 'flex-end', marginTop: '12px' }}>
                          <button
                            onClick={() => handleExport(quote)}
                            className="btn-primary"
                            style={{ padding: '4px 16px', fontSize: '0.85rem' }}
                          >
                            å¯¼å‡ºExcel
                          </button>
                        </div>
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          );
        });
      };

      return (
        <div className="app">
          {/* å…¬æŠ¥ä»·é…ç½® */}
          <div className="card">
            <h2 className="title">âœ¨ åˆ›å»ºå…¬æŠ¥ä»·</h2>

            <div className="config-group">
              <label>ğŸ“¦ ä»“ç¾¤</label>
              <select value={warehouseGroupId} disabled>
                {warehouseGroups.map(g => <option key={g.id} value={g.id}>{g.name}</option>)}
              </select>
            </div>

            <div className="config-group">
              <label>ğŸ“Š æˆæœ¬ç±»å‹</label>
              <select value={costTypeId} disabled>
                {filteredCostTypes.map(ct => <option key={ct.id} value={ct.id}>{ct.name} ({ct.unit})</option>)}
              </select>
            </div>

            <div className="config-group">
              <label>ğŸ“… å¼€å§‹æ—¥æœŸ</label>
              <DatePicker
                style={{ width: '100%' }}
                value={moment(startDate)}
                onChange={(date, dateString) => {
                  if (dateString) setStartDate(dateString);
                }}
                allowClear={false}
              />
              <div style={{ fontSize: '0.85rem', color: '#8c8c8c', marginTop: '4px' }}>
                æœ‰æ•ˆæœŸï¼š{effectiveDate} è‡³ {expiryDate}
              </div>
            </div>

            <div className="config-group">
              <label>ğŸ·ï¸ å…¬æŠ¥ä»·åç§°ï¼ˆå¯é€‰ï¼‰</label>
              <Input
                placeholder="ä¾‹å¦‚ï¼šåŒ11å¤§ä¿ƒä»·"
                value={quoteName}
                onChange={(e) => setQuoteName(e.target.value)}
              />
            </div>

            <div className="config-group">
              <label>ğŸ’° åˆ©æ¶¦ç‡</label>
              <InputNumber
                style={{ width: '100%' }}
                value={profitMargin * 100}
                onChange={(val) => setProfitMargin((val || 0) / 100)}
                min={0}
                max={200}
                formatter={value => `${value}%`}
                parser={value => value.replace('%', '')}
              />
            </div>

            {!currentCost ? (
              <button onClick={openCostModal} className="btn-primary" style={{ width: '100%', marginTop: '16px' }}>
                âš ï¸ è¯·å…ˆè®¾ç½®æˆæœ¬
              </button>
            ) : (
              <>
                <button 
                  onClick={generatePublicQuote} 
                  className="btn-primary" 
                  style={{ width: '100%', marginTop: '16px' }}
                  disabled={!canGenerate}
                >
                  {canGenerate ? 'ç”Ÿæˆå…¬æŠ¥ä»·' : 'é…ç½®ä¸åŒ¹é…'}
                </button>
                <div style={{ fontSize: '0.9rem', color: '#52c41a', marginTop: '8px' }}>
                  âœ… æˆæœ¬å·²è®¾ç½®ï¼š{currentCost.tiers.length} ä¸ªé˜¶æ¢¯
                </div>
              </>
            )}

            <div className="debug-info">
              ğŸ“Š å…¨å±€å…¬æŠ¥ä»·æ€»æ•°: {publicQuotes.length}
            </div>
          </div>

          {/* å®¢æˆ·ä»·å¡ */}
          <div className="card">
            <h2 className="title">ğŸ¯ å®¢æˆ·ä¸“å±ä»·å¡</h2>
            <div className="config-group">
              <label>é€‰æ‹©å®¢æˆ·</label>
              <select 
                value={selectedCustomerId} 
                onChange={(e) => setSelectedCustomerId(Number(e.target.value))}
              >
                {customers.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
              </select>
            </div>

            <div className="debug-info">
              ğŸ” å®¢æˆ·ä¸Šä¸‹æ–‡: {contextWg} - {contextCt}
            </div>

            <div className="config-group">
              <label>é€‰æ‹©å…¬æŠ¥ä»·ï¼ˆåŸºå‡†ï¼‰</label>
              <select
                value={selectedPublicQuoteId !== null ? String(selectedPublicQuoteId) : ''}
                onChange={(e) => {
                  const val = e.target.value;
                  setSelectedPublicQuoteId(val === '' ? null : Number(val));
                }}
              >
                <option value="">-- å…± {availablePublicQuotes.length} æ¡ --</option>
                {availablePublicQuotes.length === 0 ? (
                  <option disabled>æš‚æ— åŒ¹é…å…¬æŠ¥ä»·</option>
                ) : (
                  availablePublicQuotes.map((q) => (
                    <option key={q.id} value={String(q.id)}>
                      {q.name} Â· {q.startDate}
                    </option>
                  ))
                )}
              </select>
            </div>

            <div className="config-group">
              <label>æ•´ä½“æŠ˜æ‰£ï¼ˆ%ï¼‰</label>
              <input
                type="number"
                value={globalDiscount}
                onChange={(e) => setGlobalDiscount(parseFloat(e.target.value) || 100)}
                min="0"
                max="200"
                step="1"
              />
            </div>

            <div style={{ marginTop: '20px' }}>
              <h3 style={{ marginBottom: '12px' }}>ä¸“å±ä»·æ˜ç»†</h3>
              <div id="customerTiersContainer">
                {renderCustomerTiers()}
              </div>
            </div>

            <button onClick={handleSaveCustomerQuote} className="btn-primary" style={{ width: '100%', marginTop: '20px' }}>
              ä¿å­˜å®¢æˆ·ä»·å¡
            </button>
          </div>

          {/* å®¢æˆ·ä¸“å±ä»·å¡é¢„è§ˆ â€”â€” âœ… å«æ—¶åˆ†ç§’ + çŠ¶æ€ç»Ÿä¸€ + å·²ä¿®å¤æ˜¾ç¤ºé—®é¢˜ */}
          <div className="card" style={{ gridColumn: '1 / -1' }}>
            <div className="preview-card">
              <h3>ğŸ“¦ å®¢æˆ·ä¸“å±ä»·å¡ï¼ˆé¢„è§ˆï¼‰</h3>
              {renderCustomerQuotesPreview()}
            </div>
          </div>

          {/* æˆæœ¬è®¾ç½®æ¨¡æ€æ¡† */}
          <Modal
            title="âš™ï¸ è®¾ç½®é˜¶æ¢¯æˆæœ¬"
            visible={showCostModal}
            onOk={saveCost}
            onCancel={() => setShowCostModal(false)}
            okText="ä¿å­˜æˆæœ¬"
            cancelText="å–æ¶ˆ"
          >
            <div>
              {tempTiers.map((tier, i) => (
                <div key={i} className="tier-row" style={{ marginBottom: '12px' }}>
                  <span>{tier.start}â€“{tier.end === Infinity ? 'âˆ' : tier.end} mÂ³</span>
                  <InputNumber
                    style={{ width: '100%' }}
                    value={tier.unitCost}
                    onChange={(val) => {
                      const newTiers = [...tempTiers];
                      newTiers[i].unitCost = val || 0;
                      setTempTiers(newTiers);
                    }}
                    min={0}
                    step={0.1}
                    formatter={value => `Â¥ ${value}`}
                    parser={value => value.replace('Â¥ ', '')}
                  />
                  <button
                    type="button"
                    onClick={() => setTempTiers(tempTiers.filter((_, idx) => idx !== i))}
                    style={{ background: '#ff4d4f', color: 'white', border: 'none', borderRadius: '4px', width: '28px', height: '28px' }}
                  >
                    Ã—
                  </button>
                </div>
              ))}
              <button
                type="button"
                onClick={() => {
                  const last = tempTiers[tempTiers.length - 1];
                  const nextStart = last.end === Infinity ? 1000 : last.end + 1;
                  setTempTiers([...tempTiers, { start: nextStart, end: nextStart + 499, unitCost: 5 }]);
                }}
                style={{ marginTop: '12px', background: '#f0f0f0', border: '1px dashed #d9d9d9', padding: '6px 12px', borderRadius: '4px' }}
              >
                + æ·»åŠ é˜¶æ¢¯
              </button>
            </div>
          </Modal>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>


