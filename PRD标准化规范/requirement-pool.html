<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>需求池管理</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css">
  <style>
    body { font-family: "Inter", "PingFang SC", "Microsoft Yahei", sans-serif; }
    .card { box-shadow: 0 6px 24px rgba(0,0,0,0.06); }
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      border: 1px solid #e5e7eb;
      background: #fff;
      font-size: 0.875rem;
      color: #374151;
      transition: all 0.15s ease;
      cursor: pointer;
    }
    .btn:hover { border-color: #3b82f6; color: #1d4ed8; }
    .btn-primary {
      background: #2563eb;
      color: #fff;
      border-color: #2563eb;
    }
    .btn-primary:hover { background: #1d4ed8; }
    .btn-sm {
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .kanban-column {
      min-width: 280px;
      flex: 1;
      background: #f9fafb;
      border-radius: 12px;
    }
    .kanban-card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transition: all 0.2s;
      cursor: pointer;
    }
    .kanban-card:hover {
      box-shadow: 0 4px 16px rgba(0,0,0,0.12);
      transform: translateY(-2px);
    }
    .priority-p0 { border-left: 4px solid #ef4444; }
    .priority-p1 { border-left: 4px solid #f59e0b; }
    .priority-p2 { border-left: 4px solid #3b82f6; }
    .priority-p3 { border-left: 4px solid #6b7280; }

    /* 看板优化 */
    .kanban-board {
      display: flex;
      gap: 1rem;
      width: 100%;
    }

    /* 表格优化 */
    table {
      width: 100%;
      table-layout: auto;
    }
  </style>
</head>
<body class="bg-gray-50">
  <!-- 顶部导航 -->
  <div class="bg-white border-b sticky top-0 z-10">
    <div class="mx-auto px-6">
      <div class="flex items-center justify-between py-4">
        <div class="flex items-center gap-3">
          <i class="fa-solid fa-inbox text-2xl text-blue-600"></i>
          <h1 class="text-xl font-bold text-gray-800">需求池管理</h1>
        </div>
        <div class="flex gap-3">
          <button class="btn" onclick="goToHome()">
            <i class="fa-solid fa-arrow-left"></i>返回规范管理
          </button>
          <button class="btn btn-primary" onclick="openAddRequirementModal()">
            <i class="fa-solid fa-plus"></i>新增需求
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="mx-auto px-6 py-6 space-y-6">
    <!-- 筛选区 -->
    <div class="card bg-white rounded-xl p-4">
      <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
        <label class="space-y-1">
          <span class="text-sm text-gray-600">需求来源</span>
          <select id="filterSource" class="w-full border rounded-lg px-3 py-2">
            <option value="">全部</option>
            <option value="客户">客户</option>
            <option value="运营">运营</option>
            <option value="技术">技术</option>
            <option value="市场">市场</option>
            <option value="管理层">管理层</option>
          </select>
        </label>
        <label class="space-y-1">
          <span class="text-sm text-gray-600">优先级</span>
          <select id="filterPriority" class="w-full border rounded-lg px-3 py-2">
            <option value="">全部</option>
            <option value="P0">P0 - 紧急重要</option>
            <option value="P1">P1 - 重要</option>
            <option value="P2">P2 - 一般</option>
            <option value="P3">P3 - 低优先级</option>
          </select>
        </label>
        <label class="space-y-1">
          <span class="text-sm text-gray-600">需求状态</span>
          <select id="filterStatus" class="w-full border rounded-lg px-3 py-2">
            <option value="">全部</option>
            <option value="待评估">待评估</option>
            <option value="已评估">已评估</option>
            <option value="规划中">规划中</option>
            <option value="开发中">开发中</option>
            <option value="已完成">已完成</option>
            <option value="已拒绝">已拒绝</option>
          </select>
        </label>
        <label class="space-y-1">
          <span class="text-sm text-gray-600">关键词</span>
          <input type="text" id="filterKeyword" placeholder="搜索需求标题" class="w-full border rounded-lg px-3 py-2">
        </label>
        <div class="flex items-end gap-2">
          <button class="btn flex-1" onclick="resetFilters()">
            <i class="fa-solid fa-rotate"></i>重置
          </button>
          <button class="btn btn-primary flex-1" onclick="applyFilters()">
            <i class="fa-solid fa-filter"></i>筛选
          </button>
        </div>
      </div>
    </div>

    <!-- 数据统计 -->
    <div class="grid grid-cols-2 md:grid-cols-6 gap-4">
      <div class="card bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-4 text-center">
        <div class="text-2xl font-bold text-blue-600" id="statTotal">0</div>
        <div class="text-sm text-blue-700 mt-1">全部需求</div>
      </div>
      <div class="card bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-xl p-4 text-center">
        <div class="text-2xl font-bold text-yellow-600" id="statPending">0</div>
        <div class="text-sm text-yellow-700 mt-1">待评估</div>
      </div>
      <div class="card bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-4 text-center">
        <div class="text-2xl font-bold text-purple-600" id="statPlanning">0</div>
        <div class="text-sm text-purple-700 mt-1">规划中</div>
      </div>
      <div class="card bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-4 text-center">
        <div class="text-2xl font-bold text-green-600" id="statDoing">0</div>
        <div class="text-sm text-green-700 mt-1">开发中</div>
      </div>
      <div class="card bg-gradient-to-br from-teal-50 to-teal-100 rounded-xl p-4 text-center">
        <div class="text-2xl font-bold text-teal-600" id="statDone">0</div>
        <div class="text-sm text-teal-700 mt-1">已完成</div>
      </div>
      <div class="card bg-gradient-to-br from-red-50 to-red-100 rounded-xl p-4 text-center">
        <div class="text-2xl font-bold text-red-600" id="statRejected">0</div>
        <div class="text-sm text-red-700 mt-1">已拒绝</div>
      </div>
    </div>

    <!-- 视图切换 -->
    <div class="flex items-center justify-between">
      <div class="flex gap-2">
        <button class="btn view-toggle active" data-view="kanban" onclick="switchView('kanban')">
          <i class="fa-solid fa-table-columns"></i>看板视图
        </button>
        <button class="btn view-toggle" data-view="list" onclick="switchView('list')">
          <i class="fa-solid fa-list"></i>列表视图
        </button>
      </div>
      <div class="text-sm text-gray-500">
        共 <span class="font-semibold text-gray-700" id="displayCount">0</span> 条需求
      </div>
    </div>

    <!-- 看板视图 -->
    <div id="kanbanView" class="overflow-x-auto">
      <div class="flex gap-4 pb-4 min-w-max">
        <div class="kanban-column p-4 flex-shrink-0">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-gray-700">待评估</h3>
            <span class="badge bg-yellow-100 text-yellow-700" id="kanban-待评估-count">0</span>
          </div>
          <div id="kanban-待评估" class="space-y-3 min-h-[200px]"></div>
        </div>

        <div class="kanban-column p-4 flex-shrink-0">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-gray-700">已评估</h3>
            <span class="badge bg-blue-100 text-blue-700" id="kanban-已评估-count">0</span>
          </div>
          <div id="kanban-已评估" class="space-y-3 min-h-[200px]"></div>
        </div>

        <div class="kanban-column p-4 flex-shrink-0">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-gray-700">规划中</h3>
            <span class="badge bg-purple-100 text-purple-700" id="kanban-规划中-count">0</span>
          </div>
          <div id="kanban-规划中" class="space-y-3 min-h-[200px]"></div>
        </div>

        <div class="kanban-column p-4 flex-shrink-0">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-gray-700">开发中</h3>
            <span class="badge bg-green-100 text-green-700" id="kanban-开发中-count">0</span>
          </div>
          <div id="kanban-开发中" class="space-y-3 min-h-[200px]"></div>
        </div>

        <div class="kanban-column p-4 flex-shrink-0">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-gray-700">已完成</h3>
            <span class="badge bg-teal-100 text-teal-700" id="kanban-已完成-count">0</span>
          </div>
          <div id="kanban-已完成" class="space-y-3 min-h-[200px]"></div>
        </div>
      </div>
    </div>

    <!-- 列表视图 -->
    <div id="listView" class="card bg-white rounded-xl overflow-hidden hidden">
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-100 text-gray-600">
            <tr>
              <th class="px-4 py-3 text-left">需求编号</th>
              <th class="px-4 py-3 text-left">需求标题</th>
              <th class="px-4 py-3 text-left">来源</th>
              <th class="px-4 py-3 text-center">优先级</th>
              <th class="px-4 py-3 text-left">预期价值</th>
              <th class="px-4 py-3 text-center">状态</th>
              <th class="px-4 py-3 text-left">提出人</th>
              <th class="px-4 py-3 text-left">提出时间</th>
              <th class="px-4 py-3 text-center">操作</th>
            </tr>
          </thead>
          <tbody id="requirementTbody" class="divide-y"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- 新增/编辑需求弹窗 -->
  <div id="requirementModal" class="fixed inset-0 bg-black/35 flex items-center justify-center z-50 hidden overflow-y-auto">
    <div class="bg-white rounded-lg shadow-2xl w-full max-w-4xl my-8">
      <div class="px-6 py-4 border-b flex items-center justify-between sticky top-0 bg-white z-10">
        <h3 class="text-base font-semibold text-gray-800" id="requirementModalTitle">新增需求</h3>
        <button class="text-gray-400 hover:text-gray-600" onclick="closeRequirementModal()">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="px-6 py-5 space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <label class="space-y-1">
            <span class="text-sm text-gray-700">需求编号 <span class="text-red-500">*</span></span>
            <input type="text" id="reqCode" class="w-full border rounded-lg px-3 py-2" placeholder="自动生成或手动输入">
          </label>
          <label class="space-y-1">
            <span class="text-sm text-gray-700">需求来源 <span class="text-red-500">*</span></span>
            <select id="reqSource" class="w-full border rounded-lg px-3 py-2">
              <option value="客户">客户</option>
              <option value="运营">运营</option>
              <option value="技术">技术</option>
              <option value="市场">市场</option>
              <option value="管理层">管理层</option>
            </select>
          </label>
          <label class="space-y-1">
            <span class="text-sm text-gray-700">提出人</span>
            <input type="text" id="reqProposer" class="w-full border rounded-lg px-3 py-2" placeholder="提出人姓名">
          </label>
        </div>

        <label class="space-y-1">
          <span class="text-sm text-gray-700">需求标题 <span class="text-red-500">*</span></span>
          <input type="text" id="reqTitle" class="w-full border rounded-lg px-3 py-2" placeholder="简明扼要描述需求">
        </label>

        <label class="space-y-1">
          <span class="text-sm text-gray-700">需求背景</span>
          <textarea id="reqBackground" rows="3" class="w-full border rounded-lg px-3 py-2" placeholder="为什么提出这个需求?当前存在什么问题?"></textarea>
        </label>

        <label class="space-y-1">
          <span class="text-sm text-gray-700">需求目标</span>
          <textarea id="reqGoal" rows="3" class="w-full border rounded-lg px-3 py-2" placeholder="期望通过这个需求达成什么目标?"></textarea>
        </label>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <label class="space-y-1">
            <span class="text-sm text-gray-700">预期价值</span>
            <select id="reqValue" class="w-full border rounded-lg px-3 py-2">
              <option value="提升收入">提升收入</option>
              <option value="降低成本">降低成本</option>
              <option value="提升效率">提升效率</option>
              <option value="改善体验">改善体验</option>
              <option value="战略布局">战略布局</option>
              <option value="其他">其他</option>
            </select>
          </label>
          <label class="space-y-1">
            <span class="text-sm text-gray-700">紧急程度</span>
            <select id="reqUrgency" class="w-full border rounded-lg px-3 py-2">
              <option value="非常紧急">非常紧急</option>
              <option value="紧急">紧急</option>
              <option value="一般">一般</option>
              <option value="不紧急">不紧急</option>
            </select>
          </label>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <label class="space-y-1">
            <span class="text-sm text-gray-700">优先级 <span class="text-red-500">*</span></span>
            <select id="reqPriority" class="w-full border rounded-lg px-3 py-2">
              <option value="P0">P0 - 紧急重要 (必须做)</option>
              <option value="P1">P1 - 重要 (应该做)</option>
              <option value="P2" selected>P2 - 一般 (可以做)</option>
              <option value="P3">P3 - 低优先级 (有空做)</option>
            </select>
          </label>
          <label class="space-y-1">
            <span class="text-sm text-gray-700">状态</span>
            <select id="reqStatus" class="w-full border rounded-lg px-3 py-2">
              <option value="待评估" selected>待评估</option>
              <option value="已评估">已评估</option>
              <option value="规划中">规划中</option>
              <option value="开发中">开发中</option>
              <option value="已完成">已完成</option>
              <option value="已拒绝">已拒绝</option>
            </select>
          </label>
        </div>

        <label class="space-y-1">
          <span class="text-sm text-gray-700">关联功能模块</span>
          <input type="text" id="reqModule" class="w-full border rounded-lg px-3 py-2" placeholder="如: 产品备案、入库管理等">
        </label>

        <label class="space-y-1">
          <span class="text-sm text-gray-700">备注</span>
          <textarea id="reqRemark" rows="2" class="w-full border rounded-lg px-3 py-2" placeholder="其他需要说明的信息"></textarea>
        </label>
      </div>
      <div class="px-6 py-3 border-t flex justify-end gap-3 bg-gray-50 sticky bottom-0">
        <button class="btn" onclick="closeRequirementModal()">取消</button>
        <button class="btn btn-primary" onclick="saveRequirement()">保存</button>
      </div>
    </div>
  </div>

  <!-- Toast提示 -->
  <div id="toast" class="fixed bottom-6 right-6 bg-gray-900 text-white px-4 py-3 rounded-lg shadow-lg text-sm opacity-0 pointer-events-none transition-opacity">
    操作成功
  </div>

  <script>
    // ==================== 数据存储 ====================
    let requirements = [
      {
        id: 1,
        code: 'REQ-2024-001',
        title: '产品备案支持批量导入尺寸',
        source: '运营',
        proposer: '张三',
        background: '目前需要手动逐个录入产品尺寸,效率低下',
        goal: '支持Excel批量导入,提升录入效率',
        value: '提升效率',
        urgency: '紧急',
        priority: 'P1',
        status: '规划中',
        module: '产品备案',
        remark: '',
        createdAt: '2024-01-05 10:30:00'
      },
      {
        id: 2,
        code: 'REQ-2024-002',
        title: '入库管理增加邮件推送功能',
        source: '客户',
        proposer: '李四',
        background: '客户希望在入库完成后自动收到邮件通知',
        goal: '提升客户体验,减少客服工作量',
        value: '改善体验',
        urgency: '一般',
        priority: 'P2',
        status: '待评估',
        module: '入库管理',
        remark: '需要考虑邮件模板和发送时机',
        createdAt: '2024-01-06 14:20:00'
      },
      {
        id: 3,
        code: 'REQ-2024-003',
        title: '费用调整支持审批流程',
        source: '管理层',
        proposer: '王五',
        background: '当前费用调整无审批机制,存在风险',
        goal: '建立费用调整审批流程,降低风险',
        value: '降低成本',
        urgency: '非常紧急',
        priority: 'P0',
        status: '开发中',
        module: '费用调整',
        remark: '需要支持多级审批',
        createdAt: '2024-01-03 09:15:00'
      }
    ];

    let filteredRequirements = [...requirements];
    let currentEditId = null;

    // ==================== 初始化 ====================
    document.addEventListener('DOMContentLoaded', () => {
      loadRequirements();
      renderKanban();
      updateStats();
    });

    function loadRequirements() {
      const saved = localStorage.getItem('requirements');
      if (saved) {
        try {
          requirements = JSON.parse(saved);
          filteredRequirements = [...requirements];
        } catch (e) {
          console.error('加载需求数据失败', e);
        }
      }
    }

    function saveToStorage() {
      localStorage.setItem('requirements', JSON.stringify(requirements));
    }

    // ==================== 视图切换 ====================
    function switchView(view) {
      document.querySelectorAll('.view-toggle').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.closest('.view-toggle').classList.add('active');

      if (view === 'kanban') {
        document.getElementById('kanbanView').classList.remove('hidden');
        document.getElementById('listView').classList.add('hidden');
        renderKanban();
      } else {
        document.getElementById('kanbanView').classList.add('hidden');
        document.getElementById('listView').classList.remove('hidden');
        renderList();
      }
    }

    // ==================== 看板渲染 ====================
    function renderKanban() {
      const statuses = ['待评估', '已评估', '规划中', '开发中', '已完成'];

      statuses.forEach(status => {
        const container = document.getElementById(`kanban-${status}`);
        const items = filteredRequirements.filter(r => r.status === status);

        container.innerHTML = items.map(req => `
          <div class="kanban-card p-3 priority-${req.priority.toLowerCase()}" onclick="viewRequirement(${req.id})">
            <div class="flex items-start justify-between mb-2">
              <span class="text-xs text-gray-500">${req.code}</span>
              <span class="badge ${getPriorityBadgeClass(req.priority)}">${req.priority}</span>
            </div>
            <h4 class="font-medium text-gray-800 mb-2 text-sm">${req.title}</h4>
            <div class="flex items-center justify-between text-xs text-gray-500">
              <span><i class="fa-solid fa-user mr-1"></i>${req.proposer}</span>
              <span class="badge bg-gray-100 text-gray-600">${req.source}</span>
            </div>
            <div class="mt-2 text-xs text-gray-400">
              <i class="fa-regular fa-clock mr-1"></i>${req.createdAt.split(' ')[0]}
            </div>
          </div>
        `).join('');

        document.getElementById(`kanban-${status}-count`).textContent = items.length;
      });

      document.getElementById('displayCount').textContent = filteredRequirements.length;
    }

    // ==================== 列表渲染 ====================
    function renderList() {
      const tbody = document.getElementById('requirementTbody');
      tbody.innerHTML = filteredRequirements.map((req, idx) => `
        <tr class="${idx % 2 ? 'bg-white' : 'bg-gray-50'}">
          <td class="px-4 py-3">${req.code}</td>
          <td class="px-4 py-3 font-medium">${req.title}</td>
          <td class="px-4 py-3"><span class="badge bg-gray-100 text-gray-600">${req.source}</span></td>
          <td class="px-4 py-3 text-center"><span class="badge ${getPriorityBadgeClass(req.priority)}">${req.priority}</span></td>
          <td class="px-4 py-3">${req.value}</td>
          <td class="px-4 py-3 text-center"><span class="badge ${getStatusBadgeClass(req.status)}">${req.status}</span></td>
          <td class="px-4 py-3">${req.proposer}</td>
          <td class="px-4 py-3">${req.createdAt}</td>
          <td class="px-4 py-3 text-center space-x-2">
            <button class="text-blue-600 hover:text-blue-700" onclick="editRequirement(${req.id})">
              <i class="fa-regular fa-pen-to-square"></i>
            </button>
            <button class="text-red-500 hover:text-red-600" onclick="deleteRequirement(${req.id})">
              <i class="fa-regular fa-trash-can"></i>
            </button>
          </td>
        </tr>
      `).join('');

      document.getElementById('displayCount').textContent = filteredRequirements.length;
    }

    // ==================== 统计更新 ====================
    function updateStats() {
      document.getElementById('statTotal').textContent = requirements.length;
      document.getElementById('statPending').textContent = requirements.filter(r => r.status === '待评估').length;
      document.getElementById('statPlanning').textContent = requirements.filter(r => r.status === '规划中').length;
      document.getElementById('statDoing').textContent = requirements.filter(r => r.status === '开发中').length;
      document.getElementById('statDone').textContent = requirements.filter(r => r.status === '已完成').length;
      document.getElementById('statRejected').textContent = requirements.filter(r => r.status === '已拒绝').length;
    }

    // ==================== 筛选 ====================
    function applyFilters() {
      const source = document.getElementById('filterSource').value;
      const priority = document.getElementById('filterPriority').value;
      const status = document.getElementById('filterStatus').value;
      const keyword = document.getElementById('filterKeyword').value.toLowerCase();

      filteredRequirements = requirements.filter(req => {
        return (!source || req.source === source) &&
               (!priority || req.priority === priority) &&
               (!status || req.status === status) &&
               (!keyword || req.title.toLowerCase().includes(keyword) || req.code.toLowerCase().includes(keyword));
      });

      renderKanban();
      toast('筛选完成');
    }

    function resetFilters() {
      document.getElementById('filterSource').value = '';
      document.getElementById('filterPriority').value = '';
      document.getElementById('filterStatus').value = '';
      document.getElementById('filterKeyword').value = '';
      filteredRequirements = [...requirements];
      renderKanban();
    }

    // ==================== 新增/编辑需求 ====================
    function openAddRequirementModal() {
      currentEditId = null;
      document.getElementById('requirementModalTitle').textContent = '新增需求';
      document.getElementById('reqCode').value = generateReqCode();
      document.getElementById('reqTitle').value = '';
      document.getElementById('reqSource').value = '客户';
      document.getElementById('reqProposer').value = '';
      document.getElementById('reqBackground').value = '';
      document.getElementById('reqGoal').value = '';
      document.getElementById('reqValue').value = '提升收入';
      document.getElementById('reqUrgency').value = '一般';
      document.getElementById('reqPriority').value = 'P2';
      document.getElementById('reqStatus').value = '待评估';
      document.getElementById('reqModule').value = '';
      document.getElementById('reqRemark').value = '';
      document.getElementById('requirementModal').classList.remove('hidden');
    }

    function editRequirement(id) {
      const req = requirements.find(r => r.id === id);
      if (!req) return;

      currentEditId = id;
      document.getElementById('requirementModalTitle').textContent = '编辑需求';
      document.getElementById('reqCode').value = req.code;
      document.getElementById('reqTitle').value = req.title;
      document.getElementById('reqSource').value = req.source;
      document.getElementById('reqProposer').value = req.proposer;
      document.getElementById('reqBackground').value = req.background;
      document.getElementById('reqGoal').value = req.goal;
      document.getElementById('reqValue').value = req.value;
      document.getElementById('reqUrgency').value = req.urgency;
      document.getElementById('reqPriority').value = req.priority;
      document.getElementById('reqStatus').value = req.status;
      document.getElementById('reqModule').value = req.module;
      document.getElementById('reqRemark').value = req.remark;
      document.getElementById('requirementModal').classList.remove('hidden');
    }

    function viewRequirement(id) {
      editRequirement(id);
    }

    function closeRequirementModal() {
      document.getElementById('requirementModal').classList.add('hidden');
      currentEditId = null;
    }

    function saveRequirement() {
      const data = {
        code: document.getElementById('reqCode').value.trim(),
        title: document.getElementById('reqTitle').value.trim(),
        source: document.getElementById('reqSource').value,
        proposer: document.getElementById('reqProposer').value.trim(),
        background: document.getElementById('reqBackground').value.trim(),
        goal: document.getElementById('reqGoal').value.trim(),
        value: document.getElementById('reqValue').value,
        urgency: document.getElementById('reqUrgency').value,
        priority: document.getElementById('reqPriority').value,
        status: document.getElementById('reqStatus').value,
        module: document.getElementById('reqModule').value.trim(),
        remark: document.getElementById('reqRemark').value.trim()
      };

      if (!data.code || !data.title) {
        toast('需求编号和标题为必填项');
        return;
      }

      if (currentEditId) {
        const req = requirements.find(r => r.id === currentEditId);
        Object.assign(req, data);
      } else {
        requirements.push({
          ...data,
          id: Date.now(),
          createdAt: new Date().toISOString().slice(0, 19).replace('T', ' ')
        });
      }

      saveToStorage();
      filteredRequirements = [...requirements];
      renderKanban();
      updateStats();
      closeRequirementModal();
      toast('保存成功');
    }

    function deleteRequirement(id) {
      if (confirm('确认删除该需求吗?')) {
        requirements = requirements.filter(r => r.id !== id);
        filteredRequirements = [...requirements];
        saveToStorage();
        renderKanban();
        updateStats();
        toast('已删除');
      }
    }

    // ==================== 工具函数 ====================
    function generateReqCode() {
      const date = new Date();
      const year = date.getFullYear();
      const count = requirements.filter(r => r.code.startsWith(`REQ-${year}`)).length + 1;
      return `REQ-${year}-${String(count).padStart(3, '0')}`;
    }

    function getPriorityBadgeClass(priority) {
      const classes = {
        'P0': 'bg-red-100 text-red-700',
        'P1': 'bg-orange-100 text-orange-700',
        'P2': 'bg-blue-100 text-blue-700',
        'P3': 'bg-gray-100 text-gray-700'
      };
      return classes[priority] || 'bg-gray-100 text-gray-700';
    }

    function getStatusBadgeClass(status) {
      const classes = {
        '待评估': 'bg-yellow-100 text-yellow-700',
        '已评估': 'bg-blue-100 text-blue-700',
        '规划中': 'bg-purple-100 text-purple-700',
        '开发中': 'bg-green-100 text-green-700',
        '已完成': 'bg-teal-100 text-teal-700',
        '已拒绝': 'bg-red-100 text-red-700'
      };
      return classes[status] || 'bg-gray-100 text-gray-700';
    }

    function toast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.remove('opacity-0');
      t.classList.add('opacity-100');
      setTimeout(() => {
        t.classList.remove('opacity-100');
        t.classList.add('opacity-0');
      }, 2000);
    }

    // ==================== 返回首页函数 ====================
    function goToHome() {
      // 检查是否在 iframe 中
      if (window.self !== window.top) {
        // 在 iframe 中，发送消息给父页面关闭弹窗
        window.parent.postMessage({ type: 'CLOSE_FEATURE_MODAL' }, '*');
        // 延迟导航，让父页面有时间关闭弹窗
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 100);
      } else {
        // 不在 iframe 中，直接导航
        window.location.href = 'index.html';
      }
    }
  </script>
</body>
</html>
