<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>财务管理 - 费用调整</title>
  <!-- 引入 Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- 引入 Font Awesome 图标 -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  
  <!-- 自定义配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#1E88E5', // 主色调（蓝色）
            secondary: '#FF9800', // 辅助色（橙色）
            neutral: '#F5F7FA', // 中性色（浅灰）
            dark: '#333647', // 深色文本
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .table-shadow {
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }
      .btn-hover {
        @apply transition-all duration-300 hover:shadow-md hover:-translate-y-0.5;
      }
      .input-focus {
        @apply focus:border-primary focus:ring-1 focus:ring-primary focus:outline-none;
      }
    }
  </style>
</head>
<body class="bg-gray-50 font-sans text-dark">
  <div class="container mx-auto px-4 py-8 max-w-7xl">
    
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
      <!-- 搜索区域 -->
      <div class="flex flex-col md:flex-row gap-4 mb-6">
        <div class="flex-1">
          <label for="feeNumber" class="block text-sm font-medium text-gray-700 mb-1">出库单号</label>
          <div class="flex items-center gap-2">
            <input 
              type="text" 
              id="feeNumber" 
              class="flex-1 px-4 py-2 border border-gray-300 rounded-lg input-focus"
              placeholder="输入出库单号查询（例如：HYNB-240126-0059）"
              value="HYNB-240126-0059"
            >
            <button id="searchBtn" class="bg-primary text-white px-6 py-2 rounded-lg btn-hover">
              <i class="fas fa-search mr-2"></i>搜索
            </button>
            <div class="relative">
              <button id="adjustFeeBtn" class="bg-secondary text-white px-6 py-2 rounded-lg btn-hover flex items-center">
                <i class="fas fa-cog mr-2"></i>批量操作
                <i class="fas fa-chevron-down ml-2"></i>
              </button>
              <div id="adjustDropdown" class="absolute hidden top-full left-0 mt-1 w-48 bg-white rounded-md shadow-lg border border-gray-200 z-10">
                <div class="py-1">
                  <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-action="cover">覆盖</a>
                  <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-action="update">更新</a>
                  <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-action="accumulate">累加</a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 功能按钮区域 -->
      <div class="flex flex-wrap gap-4 mb-6">
        <button id="addFeeBtn" class="bg-primary text-white px-6 py-2 rounded-lg btn-hover flex items-center">
          <i class="fas fa-plus mr-2"></i>新增费用项
        </button>
      </div>
      
      <!-- 长宽高和体积重信息区域 -->
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
        <div class="flex items-center mb-3">
          <i class="fas fa-cube text-blue-500 mr-2"></i>
          <h4 class="text-sm font-semibold text-blue-800">包裹尺寸信息</h4>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="flex items-center">
            <span class="text-sm text-gray-600 mr-2">长宽高:</span>
            <span id="dimensionsDisplay" class="text-sm font-medium text-gray-900">-</span>
            <span class="text-sm text-gray-500 ml-1">(cm³)</span>
          </div>
          <div class="flex items-center">
            <span class="text-sm text-gray-600 mr-2">体积重:</span>
            <span id="volumeWeightDisplay" class="text-sm font-medium text-gray-900">-</span>
            <span class="text-sm text-gray-500 ml-1">(kg)</span>
          </div>
          <div class="flex items-center">
            <span class="text-sm text-gray-600 mr-2">计费重:</span>
            <span id="chargeableWeightDisplay" class="text-sm font-medium text-gray-900">-</span>
            <span class="text-sm text-gray-500 ml-1">(kg)</span>
          </div>
        </div>
      </div>
      
      <!-- 费用明细表格 -->
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 table-shadow rounded-lg overflow-hidden">
          <thead class="bg-gray-50">
            <tr>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">费用名称</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">计费单位</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">原金额</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">新金额</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">币别</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">备注</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
            </tr>
          </thead>
          <tbody id="feeTableBody" class="bg-white divide-y divide-gray-200">
            <!-- 表格数据将通过JS动态生成 -->
          </tbody>
        </table>
      </div>
      
      <!-- 无数据提示 -->
      <div id="emptyState" class="hidden py-16 text-center">
        <i class="far fa-file-alt text-gray-300 text-5xl mb-4"></i>
        <p class="text-gray-500">暂无费用数据，请点击"新增费用项"添加</p>
      </div>
    </div>
  </div>
  
  <!-- 上传文件模态框 -->
  <div id="uploadModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-auto relative animate-fade-in">
      <!-- 模态框头部 -->
      <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
        <h3 class="text-xl font-semibold text-gray-800">
          <i class="fas fa-upload text-primary mr-2"></i>
          批量操作
        </h3>
        <button id="closeUploadModal" class="text-gray-400 hover:text-gray-600 transition-colors duration-200 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100">
          <i class="fas fa-times"></i>
        </button>
      </div>

    <!-- 上传说明 -->
    <div class="mt-4 p-2 rounded-lg">
      <div class="flex items-start">
        <i class="fas fa-exclamation-triangle text-red-500 mt-0.5 mr-2"></i>
        <div>
          <h4 class="text-sm font-medium text-red-500 mb-1">注意：修改后订单不支持重新计费，请谨慎操作！</h4>
        </div>
      </div>
    </div>
      <!-- 模态框内容 -->
       
      <div class="px-4 py-3">
        <!-- 上传区域 -->
        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-primary transition-colors duration-200">
          <div class="mb-3">
            <i class="fas fa-cloud-upload text-3xl text-gray-400"></i>
          </div>
          <p class="text-gray-600 mb-2 text-sm">拖拽文件到此处或点击选择文件</p>
          <p class="text-xs text-gray-500 mb-3">支持 Excel (.xlsx, .xls) 和 CSV (.csv) 格式，文件大小不超过 10MB</p>
          <input type="file" id="fileInput" class="hidden" accept=".xlsx,.xls,.csv">
          <button id="selectFileBtn" class="px-3 py-1.5 bg-primary text-white rounded-md hover:bg-primary/90 transition-colors duration-200 text-sm">
            <i class="fas fa-folder-open mr-1.5"></i>选择文件
          </button>
        </div>

        <!-- 已选择的文件列表 -->
        <div id="selectedFiles" class="mt-3 hidden">
          <h4 class="text-sm font-medium text-gray-700 mb-2">已选择的文件：</h4>
          <div class="space-y-2">
            <div class="flex items-center justify-between p-2 bg-gray-50 rounded-md">
              <div class="flex items-center">
                <i class="fas fa-file-excel text-green-600 mr-2"></i>
                <div>
                  <p class="text-sm font-medium text-gray-900" id="fileName">批量调整表.xlsx</p>
                  <p class="text-xs text-gray-500" id="fileSize">2.3 MB</p>
                </div>
              </div>
              <button id="removeFileBtn" class="text-red-500 hover:text-red-700 transition-colors duration-200">
                <i class="fas fa-times-circle"></i>
              </button>
            </div>
          </div>
        </div>

      </div>

      <!-- 模态框底部 -->
      <div class="px-4 py-3 border-t border-gray-200 flex items-center justify-between">
        <div class="text-xs text-blue-500">
          <span id="uploadStatus">下载模板</span>
        </div>
        <div class="flex items-center gap-2">
          <button id="cancelUploadBtn" class="px-3 py-1.5 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-colors duration-200 focus:outline-none focus:ring-1 focus:ring-primary focus:ring-offset-1 text-sm">
            取消
          </button>
          <button id="startUploadBtn" disabled
            class="px-3 py-1.5 bg-gray-300 text-gray-500 rounded-md cursor-not-allowed text-sm"
            title="请先选择文件">
            <i class="fas fa-upload mr-1"></i>
            开始上传
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 提示消息组件 -->
  <div id="toast" class="fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 z-50 flex items-center">
    <i id="toastIcon" class="mr-2 text-xl"></i>
    <span id="toastMessage"></span>
  </div>

  <script>
    // 全局变量
    let feeData = [];
    let currentEditId = null;
    
    // DOM 元素
    const feeTableBody = document.getElementById('feeTableBody');
    const emptyState = document.getElementById('emptyState');
    const searchBtn = document.getElementById('searchBtn');
    const searchInput = document.getElementById('searchInput');
    const adjustFeeBtn = document.getElementById('adjustFeeBtn');
    const adjustDropdown = document.getElementById('adjustDropdown');
    const uploadModal = document.getElementById('uploadModal');
    const closeUploadModal = document.getElementById('closeUploadModal');
    const cancelUploadBtn = document.getElementById('cancelUploadBtn');
    const selectFileBtn = document.getElementById('selectFileBtn');
    const fileInput = document.getElementById('fileInput');
    const removeFileBtn = document.getElementById('removeFileBtn');
    const startUploadBtn = document.getElementById('startUploadBtn');
    const selectedFiles = document.getElementById('selectedFiles');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const uploadStatus = document.getElementById('uploadStatus');
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');
    const toastIcon = document.getElementById('toastIcon');
    
    // 初始化
    document.addEventListener('DOMContentLoaded', () => {
      // 使用 requestAnimationFrame 优化渲染性能
      requestAnimationFrame(() => {
        // 加载本地存储的数据
        loadFeeData();
        // 渲染表格
        renderFeeTable();
        // 更新尺寸显示区域
        updateDimensionsDisplay();
        // 绑定事件
        bindEvents();
      });
    });
    
    // 更新尺寸显示区域
    function updateDimensionsDisplay() {
      // 缓存DOM元素查询
      const dimensionsDisplay = document.getElementById('dimensionsDisplay');
      const volumeWeightDisplay = document.getElementById('volumeWeightDisplay');
      const chargeableWeightDisplay = document.getElementById('chargeableWeightDisplay');
      
      if (feeData.length === 0) {
        dimensionsDisplay.textContent = '-';
        volumeWeightDisplay.textContent = '-';
        chargeableWeightDisplay.textContent = '-';
        return;
      }
      
      // 计算总体积重和计费重
      let totalVolumeWeight = 0;
      let totalActualWeight = 0;
      let hasDimensions = false;
      let dimensionsList = [];

      feeData.forEach(fee => {
        if (fee.volumeWeight) {
          totalVolumeWeight += fee.volumeWeight;
        }
        if (fee.unit === 'KG') {
          totalActualWeight += fee.amount; // 使用金额作为重量参考
        }
        if (fee.dimensions) {
          hasDimensions = true;
          dimensionsList.push(fee.dimensions);
        }
      });
      
      // 批量更新DOM，减少重排重绘
      const updates = {
        dimensions: hasDimensions ? dimensionsList.join(', ') : '-',
        volumeWeight: totalVolumeWeight > 0 ? totalVolumeWeight.toFixed(2) : '-',
        chargeableWeight: Math.max(totalActualWeight, totalVolumeWeight) > 0 ?
                          Math.max(totalActualWeight, totalVolumeWeight).toFixed(2) : '-'
      };
      
      dimensionsDisplay.textContent = updates.dimensions;
      volumeWeightDisplay.textContent = updates.volumeWeight;
      chargeableWeightDisplay.textContent = updates.chargeableWeight;
    }
    
    // 费用名称选项
    const feeNameOptions = [
      '超长费',
      '超重费',
      '燃油附加费',
      '偏远地区附加费',
      '仓储费',
      '其他费用'
    ];
    
    // 加载数据
    function loadFeeData() {
      const savedData = localStorage.getItem('feeData');
      if (savedData) {
        feeData = JSON.parse(savedData);
      } else {
        // 初始示例数据
        feeData = [
          {
            name: '超长费',
            unit: 'KG',
            amount: 255,
            newAmount: null,
            currency: 'USD',
            dimensions: '120x80x60',
            volumeWeight: 57.6,
            remark: '这是一段备注'
          },
          {
            name: '超重费',
            unit: '箱',
            amount: 250,
            newAmount: null,
            currency: 'USD',
            dimensions: '100x100x100',
            volumeWeight: 100.0,
            remark: '超出重量限制附加费'
          }
        ];
        saveFeeData();
      }
    }
    
    // 保存费用数据到localStorage
    function saveFeeData() {
      localStorage.setItem('feeData', JSON.stringify(feeData));
    }
    
    // 渲染表格
    function renderFeeTable() {
      if (feeData.length === 0) {
        feeTableBody.innerHTML = '';
        emptyState.classList.remove('hidden');
        return;
      }
      
      emptyState.classList.add('hidden');
      
      // 使用 DocumentFragment 优化DOM操作
      const fragment = document.createDocumentFragment();
      
      feeData.forEach(fee => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50 transition-colors';
        tr.dataset.id = fee.id;
        tr.innerHTML = `
          <td class="px-4 py-3 text-sm">${fee.name}</td>
          <td class="px-4 py-3 text-sm">${fee.unit}</td>
          <td class="px-4 py-3 text-sm font-medium text-gray-700 bg-gray-50 rounded">${fee.amount.toFixed(2)}</td>
          <td class="px-4 py-3 text-sm font-medium text-primary bg-blue-50 rounded">${fee.newAmount ? fee.newAmount.toFixed(2) : '-'}</td>
          <td class="px-4 py-3 text-sm">${fee.currency}</td>
          <td class="px-4 py-3 text-sm">${fee.remark || '-'}</td>
          <td class="px-4 py-3 text-sm">
            <button class="px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors mr-1" onclick="editFee('${fee.id}')">
              <i class="fas fa-edit"></i>
            </button>
            <button class="px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600 transition-colors" onclick="deleteFee('${fee.id}')">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        fragment.appendChild(tr);
      });
      
      // 一次性添加所有行到DOM
      feeTableBody.innerHTML = '';
      feeTableBody.appendChild(fragment);
      
      // 绑定表格行内按钮事件
      bindTableEvents();
    }
    
    // 渲染新增行
    function renderNewRow() {
      // 获取已使用的费用类型
      const usedFeeNames = feeData.map(fee => fee.name);
      // 过滤出可用的费用选项
      const availableFeeOptions = feeNameOptions.filter(name => !usedFeeNames.includes(name));

      const tr = document.createElement('tr');
      tr.className = 'bg-blue-50 border-l-4 border-blue-400';
      tr.dataset.mode = 'new';
      tr.innerHTML = `
        <td class="px-4 py-3 text-sm">
          <select class="w-full px-2 py-1 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500" data-field="name">
            <option value="">请选择费用名称</option>
            ${availableFeeOptions.map(name => `<option value="${name}">${name}</option>`).join('')}
            ${usedFeeNames.length > 0 ? '<optgroup label="已使用的费用类型（不可选择）">' +
              usedFeeNames.map(name => `<option value="${name}" disabled>${name} (已使用)</option>`).join('') +
              '</optgroup>' : ''}
          </select>
        </td>
        <td class="px-4 py-3 text-sm">
          <select class="w-full px-2 py-1 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500" data-field="unit">
            <option value="个">个</option>
            <option value="套">套</option>
            <option value="次">次</option>
            <option value="小时">小时</option>
            <option value="天">天</option>
            <option value="月">月</option>
            <option value="年">年</option>
            <option value="平方米">平方米</option>
            <option value="立方米">立方米</option>
            <option value="千克">千克</option>
            <option value="吨">吨</option>
            <option value="公里">公里</option>
          </select>
        </td>
        <td class="px-4 py-3 text-sm">
          <input type="number" class="w-24 px-2 py-1 border border-gray-300 rounded-md bg-gray-50" placeholder="原金额" readonly data-field="amount">
        </td>
        <td class="px-4 py-3 text-sm">
          <input type="number" class="w-24 px-2 py-1 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="新金额" step="0.01" min="0" data-field="newAmount">
        </td>
        <td class="px-4 py-3 text-sm">
          <select class="w-full px-2 py-1 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500" data-field="currency">
            <option value="CNY">人民币</option>
            <option value="USD">美元</option>
            <option value="EUR">欧元</option>
          </select>
        </td>
        <td class="px-4 py-3 text-sm">
          <input type="text" class="w-full px-2 py-1 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="备注" data-field="remark">
        </td>
        <td class="px-4 py-3 text-sm">
          <div class="flex space-x-1">
            <button class="px-2 py-1 bg-green-500 text-white rounded hover:bg-green-600 transition-colors" onclick="saveNewRow()">
              <i class="fas fa-check"></i>
            </button>
            <button class="px-2 py-1 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors" onclick="cancelNewRow()">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </td>
      `;
      feeTableBody.appendChild(tr);

      // 绑定新增行的事件
      bindNewRowEvents(tr);
    }
    
    // 绑定表格事件
    function bindTableEvents() {
      // 事件已通过委托在bindEvents中处理，无需重复绑定
    }
    
    // 绑定新增行事件
    function bindNewRowEvents(row) {
      const newAmountInput = row.querySelector('[data-field="newAmount"]');
      // 不再自动计算金额，新金额由用户手动填写
    }
    
    // 保存新行
    function saveNewRow() {
      const row = document.querySelector('tr[data-mode="new"]');
      if (!row) return;

      const name = row.querySelector('[data-field="name"]').value.trim();
      const unit = row.querySelector('[data-field="unit"]').value;
      const amount = parseFloat(row.querySelector('[data-field="amount"]').value);
      const newAmount = parseFloat(row.querySelector('[data-field="newAmount"]').value);
      const currency = row.querySelector('[data-field="currency"]').value;
      const remark = row.querySelector('[data-field="remark"]').value.trim();

      if (!name || !unit || isNaN(amount) || isNaN(newAmount)) {
        showToast('请填写完整且有效的信息', 'error');
        return;
      }

      // 检查费用类型是否已存在
      const isDuplicate = feeData.some(fee => fee.name === name);
      if (isDuplicate) {
        showToast(`费用类型"${name}"已存在，请选择其他费用类型`, 'error');
        return;
      }

      const newFee = {
        id: Date.now().toString(),
        name,
        unit,
        amount,
        newAmount,
        currency,
        remark
      };

      feeData.unshift(newFee);
      saveFeeData();
      renderFeeTable();
      updateDimensionsDisplay();
      showToast('费用项新增成功', 'success');
    }
    
    // 取消新增行
    function cancelNewRow() {
      renderFeeTable();
    }
    
    // 绑定事件
    function bindEvents() {
      // 使用事件委托优化事件处理
      const container = document.querySelector('.container');
      
      // 委托处理表格按钮点击事件
      container.addEventListener('click', (e) => {
        if (e.target.classList.contains('btn-edit')) {
          const id = e.target.getAttribute('data-id');
          editFee(id);
        } else if (e.target.classList.contains('btn-delete')) {
          const id = e.target.getAttribute('data-id');
          deleteFee(id);
        } else if (e.target.classList.contains('btn-save')) {
          saveFee();
        } else if (e.target.classList.contains('btn-cancel')) {
          cancelEdit();
        } else if (e.target.classList.contains('btn-add')) {
          addNewRow();
        }
      });
      
      // 委托处理输入变化事件（删除了单价和数量的自动计算逻辑）
      container.addEventListener('input', (e) => {
        if (e.target.classList.contains('fee-length') ||
                   e.target.classList.contains('fee-width') ||
                   e.target.classList.contains('fee-height')) {
          calculateVolumeWeight(e.target);
        }
      });
      
      // 新增费用项按钮
      const addFeeBtn = document.getElementById('addFeeBtn');
      if (addFeeBtn) {
        addFeeBtn.addEventListener('click', showNewRow);
      }
      
      // 调整费用下拉菜单
      adjustFeeBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        adjustDropdown.classList.toggle('hidden');
      });
      
      // 点击其他区域关闭下拉菜单
      document.addEventListener('click', () => {
        adjustDropdown.classList.add('hidden');
      });
      
      // 调整下拉菜单项点击事件 - 触发上传弹窗
      document.querySelectorAll('#adjustDropdown a').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          adjustDropdown.classList.add('hidden');
          openUploadModal();
        });
      });
      
      // 上传弹窗相关事件
      closeUploadModal.addEventListener('click', closeUploadModalHandler);
      cancelUploadBtn.addEventListener('click', closeUploadModalHandler);
      selectFileBtn.addEventListener('click', () => fileInput.click());
      removeFileBtn.addEventListener('click', removeSelectedFile);
      startUploadBtn.addEventListener('click', startUpload);
      
      // 文件选择事件
      fileInput.addEventListener('change', handleFileSelect);
      
      // 点击上传弹窗外部关闭
      uploadModal.addEventListener('click', (e) => {
        if (e.target === uploadModal) closeUploadModalHandler();
      });
      
      // 搜索功能
      searchBtn.addEventListener('click', performSearch);
    }
    
    // 显示新增行
    function showNewRow() {
      // 隐藏空状态提示
      emptyState.classList.add('hidden');
      // 渲染新增行
      renderNewRow();
      // 获取新增行并绑定事件
      const newRow = document.querySelector('tr[data-mode="new"]');
      if (newRow) {
        bindNewRowEvents(newRow);
      }
    }
    
    // 打开新增模态框
    function openAddModal() {
      modalTitle.textContent = '新增费用项';
      feeForm.reset();
      document.getElementById('feeId').value = '';
      currentEditId = null;
      feeModal.classList.remove('hidden');
    }
    
    // 编辑费用项（行内编辑）
    function editFee(id) {
      const row = document.querySelector(`tr[data-id="${id}"]`);
      if (!row) return;

      const fee = feeData.find(item => item.id === id);
      if (!fee) return;

      // 获取其他费用项已使用的费用类型（排除当前编辑项）
      const usedFeeNames = feeData
        .filter(item => item.id !== id)
        .map(item => item.name);

      // 过滤出可用的费用选项
      const availableFeeOptions = feeNameOptions.filter(name => !usedFeeNames.includes(name));

      // 将行转换为编辑状态
      row.innerHTML = `
        <td class="px-4 py-3 text-sm">
          <select class="w-full px-2 py-1 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500" data-field="name">
            <option value="">请选择费用名称</option>
            ${availableFeeOptions.map(name => `<option value="${name}" ${fee.name === name ? 'selected' : ''}>${name}</option>`).join('')}
            ${usedFeeNames.length > 0 ? '<optgroup label="已使用的费用类型（不可选择）">' +
              usedFeeNames.map(name => `<option value="${name}" disabled>${name} (已使用)</option>`).join('') +
              '</optgroup>' : ''}
          </select>
        </td>
        <td class="px-4 py-3 text-sm">
          <select class="w-full px-2 py-1 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500" data-field="unit">
            <option value="个" ${fee.unit === '个' ? 'selected' : ''}>个</option>
            <option value="套" ${fee.unit === '套' ? 'selected' : ''}>套</option>
            <option value="次" ${fee.unit === '次' ? 'selected' : ''}>次</option>
          </select>
        </td>
        <td class="px-4 py-3 text-sm">
          <input type="number" class="w-24 px-2 py-1 border border-gray-300 rounded-md bg-gray-50" value="${fee.amount}" data-field="amount" step="0.01" readonly>
        </td>
        <td class="px-4 py-3 text-sm">
          <input type="number" class="w-24 px-2 py-1 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500" value="${fee.newAmount ? fee.newAmount : ''}" data-field="newAmount" step="0.01" min="0">
        </td>
        <td class="px-4 py-3 text-sm">
          <select class="w-full px-2 py-1 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500" data-field="currency">
            <option value="CNY" ${fee.currency === 'CNY' ? 'selected' : ''}>人民币</option>
            <option value="USD" ${fee.currency === 'USD' ? 'selected' : ''}>美元</option>
            <option value="EUR" ${fee.currency === 'EUR' ? 'selected' : ''}>欧元</option>
          </select>
        </td>
        <td class="px-4 py-3 text-sm">
          <input type="text" class="w-full px-2 py-1 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500" value="${fee.remark || ''}" data-field="remark">
        </td>
        <td class="px-4 py-3 text-sm">
          <div class="flex space-x-1">
            <button class="px-2 py-1 bg-green-500 text-white rounded hover:bg-green-600 transition-colors" onclick="saveEditRow('${id}')">
              <i class="fas fa-check"></i>
            </button>
            <button class="px-2 py-1 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors" onclick="cancelEditRow('${id}')">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </td>
      `;

      // 绑定编辑行的事件
      bindEditRowEvents(row, id);
    }
    
    // 绑定编辑行的事件
    function bindEditRowEvents(row, id) {
      const newAmountInput = row.querySelector('[data-field="newAmount"]');
      // 不再自动计算金额，新金额由用户手动填写
    }
    
    // 保存编辑行
    function saveEditRow(id) {
      const row = document.querySelector(`tr[data-id="${id}"]`);
      if (!row) return;

      const name = row.querySelector('select[data-field="name"]').value.trim();
      const unit = row.querySelector('select[data-field="unit"]').value;
      const amount = parseFloat(row.querySelector('[data-field="amount"]').value);
      const newAmount = parseFloat(row.querySelector('[data-field="newAmount"]').value);
      const currency = row.querySelector('select[data-field="currency"]').value;
      const remark = row.querySelector('input[data-field="remark"]').value.trim();

      // 验证
      if (!name || !unit || isNaN(amount) || isNaN(newAmount)) {
        showToast('请填写完整且有效的信息', 'error');
        return;
      }

      // 检查费用类型是否与其他费用项重复（排除当前编辑项）
      const isDuplicate = feeData.some(fee => fee.id !== id && fee.name === name);
      if (isDuplicate) {
        showToast(`费用类型"${name}"已被其他费用项使用，请选择其他费用类型`, 'error');
        return;
      }

      // 更新数据
      const index = feeData.findIndex(item => item.id === id);
      if (index !== -1) {
        feeData[index] = {
          ...feeData[index],
          name,
          unit,
          amount,
          newAmount,
          currency,
          remark
        };

        // 保存并重新渲染
        saveFeeData();
        renderFeeTable();
        updateDimensionsDisplay();
        showToast('费用项更新成功', 'success');
      }
    }
    
    // 取消编辑行
    function cancelEditRow(id) {
      renderFeeTable();
    }
    
    // 删除费用项
    function deleteFee(id) {
      if (confirm('确定要删除这个费用项吗？此操作不可撤销。')) {
        feeData = feeData.filter(item => item.id !== id);
        saveFeeData();
        renderFeeTable();
        updateDimensionsDisplay();
        showToast('费用项删除成功', 'success');
      }
    }
    
    // 搜索功能
    function performSearch() {
      const searchValue = document.getElementById('feeNumber').value.trim();
      if (searchValue) {
        showToast(`正在查询编号：${searchValue}`, 'info');
        // 模拟搜索延迟
        setTimeout(() => {
          // 实际项目中这里会调用接口查询
          showToast(`查询完成，共找到${feeData.length}条相关记录`, 'success');
        }, 800);
      } else {
        showToast('请输入费用编号', 'error');
      }
    }
    
    // 显示提示消息
    function showToast(message, type = 'success') {
      const toastMessage = document.getElementById('toastMessage');
      const toastIcon = document.getElementById('toastIcon');
      
      toastMessage.textContent = message;
      
      // 设置图标和样式
      switch(type) {
        case 'success':
          toast.className = 'fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg transform translate-x-0 transition-transform duration-300 z-50 flex items-center bg-green-50 text-green-700 border-l-4 border-green-400';
          toastIcon.className = 'mr-2 text-xl fas fa-check-circle text-green-500';
          break;
        case 'error':
          toast.className = 'fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg transform translate-x-0 transition-transform duration-300 z-50 flex items-center bg-red-50 text-red-700 border-l-4 border-red-400';
          toastIcon.className = 'mr-2 text-xl fas fa-exclamation-circle text-red-500';
          break;
        case 'info':
          toast.className = 'fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg transform translate-x-0 transition-transform duration-300 z-50 flex items-center bg-blue-50 text-blue-700 border-l-4 border-blue-400';
          toastIcon.className = 'mr-2 text-xl fas fa-info-circle text-blue-500';
          break;
      }
      
      // 3秒后隐藏
      setTimeout(() => {
        toast.classList.add('translate-x-full');
      }, 3000);
    }
    
    // 打开上传弹窗
    function openUploadModal() {
      uploadModal.classList.remove('hidden');
      resetUploadForm();
    }
    
    // 关闭上传弹窗
    function closeUploadModalHandler() {
      uploadModal.classList.add('hidden');
      resetUploadForm();
    }
    
    // 重置上传表单
    function resetUploadForm() {
      fileInput.value = '';
      selectedFiles.classList.add('hidden');
      startUploadBtn.disabled = true;
      startUploadBtn.className = 'px-4 py-2 bg-gray-300 text-gray-500 rounded-md cursor-not-allowed';
      startUploadBtn.title = '请先选择文件';
      uploadStatus.textContent = '下载模板';
    }
    
    // 处理文件选择
    function handleFileSelect(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      // 验证文件类型
      const allowedTypes = ['.xlsx', '.xls', '.csv'];
      const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
      
      if (!allowedTypes.includes(fileExtension)) {
        showToast('请选择Excel或CSV格式的文件', 'error');
        fileInput.value = '';
        return;
      }
      
      // 验证文件大小（10MB）
      const maxSize = 10 * 1024 * 1024;
      if (file.size > maxSize) {
        showToast('文件大小不能超过10MB', 'error');
        fileInput.value = '';
        return;
      }
      
      // 显示文件信息
      fileName.textContent = file.name;
      fileSize.textContent = formatFileSize(file.size);
      selectedFiles.classList.remove('hidden');
      
      // 启用上传按钮
      startUploadBtn.disabled = false;
      startUploadBtn.className = 'px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/90 transition-colors duration-200';
      startUploadBtn.title = '';
      
      uploadStatus.textContent = '文件已选择，准备上传';
    }
    
    // 移除选中的文件
    function removeSelectedFile() {
      resetUploadForm();
    }
    
    // 开始上传
    function startUpload() {
      const file = fileInput.files[0];
      if (!file) {
        showToast('请先选择文件', 'error');
        return;
      }
      
      // 更新状态
      uploadStatus.textContent = '正在上传...';
      startUploadBtn.disabled = true;
      startUploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1.5"></i>上传中...';
      
      // 模拟上传过程
      setTimeout(() => {
        // 模拟成功上传
        uploadStatus.textContent = '上传成功';
        showToast('文件上传成功，数据处理完成', 'success');
        
        // 模拟添加新数据
        const newFees = [
          {
            id: Date.now().toString(),
            name: '上传费用-超长费',
            unit: 'KG',
            amount: 420,
            newAmount: null,
            currency: 'USD',
            remark: '通过文件上传导入'
          },
          {
            id: (Date.now() + 1).toString(),
            name: '上传费用-超重费',
            unit: '箱',
            amount: 440,
            newAmount: null,
            currency: 'USD',
            remark: '通过文件上传导入'
          }
        ];
        
        // 添加新数据到现有数据
        feeData = [...newFees, ...feeData];
        saveFeeData();
        renderFeeTable();
        
        // 延迟关闭弹窗
        setTimeout(() => {
          closeUploadModalHandler();
        }, 1500);
        
      }, 2000);
    }
    
    // 格式化文件大小
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
  </script>
</body>
</html>